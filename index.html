<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>ASCII Двостороння Дорога</title>
<link rel="icon" href="data:image/svg+xml,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
  <text x='50%' y='55%' font-size='40' text-anchor='middle' fill='white' font-family='monospace'>=[-]=</text>
</svg>">
<style>
body {
  margin:0; height:100vh; background:#191919;
  font-family:monospace; white-space:pre; overflow:hidden;
}
.car { position:absolute; font-weight:bold; will-change:transform; }
.lane, .divider { position:absolute; width:100%; pointer-events:none; }
.lane { border-top:1px solid gray; opacity:0.3; }
.divider { border-top:4px double yellow; opacity:0.8; }
</style>
</head>
<body>
<script>
const carSprites = ['=(o)≡','≡[+]≡','(o)=(o)=[:]','=[:]=','<[•)>','=[-]=','[]=o=[]','<(o)>'],
      carColors  = ['red','orange','yellow','lime','cyan','blue','magenta','white'],
      cars = [];

const laneCount = 3,
      safeDistance = 7,
      laneHeight = 30,
      screenWidth = innerWidth,
      cellWidth = 10,
      maxCells = screenWidth / cellWidth;

const addEl = (cls, top) => {
  const el = document.createElement('div');
  el.className = cls;
  el.style.top = top + 'px';
  document.body.appendChild(el);
  return el;
};

// координати смуг
const laneTops = Array.from({length: laneCount*2}, (_,i)=>
  i*laneHeight + (i>=laneCount?laneHeight/2:0)
);

// лінії дороги
laneTops.forEach(t=>addEl('lane',t));
[ laneCount*laneHeight, laneCount*laneHeight + laneHeight/2 ]
  .forEach(t=>addEl('divider',t));
addEl('lane', laneTops.at(-1) + laneHeight);

// машини
carSprites.forEach((sprite,i)=>{
  const lane = i % (laneCount*2),
        car  = document.createElement('div');
  car.className = 'car';
  car.textContent = sprite;
  car.style.color = carColors[i % carColors.length];
  car.style.top = laneTops[lane] + (lane===laneCount?12:5) + 'px';
  document.body.appendChild(car);

  cars.push({
    element: car,
    x: Math.random() * maxCells,
    spriteLen: sprite.length, // кешуємо довжину
    speed: (0.5 + Math.random()*2)/16,
    direction: lane < laneCount ? -1 : 1,
    lane,
    currentSpeed: 0
  });
});

// групуємо машини по смугах для швидшого пошуку
function adjustSpeeds() {
  const byLane = {};
  cars.forEach(c=>{
    (byLane[c.lane] ||= []).push(c);
  });

  for(const lane in byLane){
    const arr = byLane[lane];
    arr.sort((a,b)=>a.x-b.x); // впорядкування по позиції

    arr.forEach((car,idx)=>{
      let slowed = false;
      const dir = car.direction;
      const neighbor = dir>0 ? arr[idx+1] : arr[idx-1];
      if(neighbor){
        const dist = Math.abs(neighbor.x - car.x);
        if((dir>0 && neighbor.x>car.x && dist<safeDistance) ||
           (dir<0 && car.x>neighbor.x && dist<safeDistance)){
          slowed = true;
        }
      }
      car.currentSpeed = slowed ? car.speed*0.3 : car.speed;
    });
  }
}

// --- Адаптивна анімація ---
let active = true;
document.addEventListener("visibilitychange", ()=>{
  active = !document.hidden;
});

function animate(){
  adjustSpeeds();
  cars.forEach(c=>{
    c.x += c.currentSpeed * c.direction;
    if(c.x > maxCells && c.direction>0) c.x = -c.spriteLen;
    if(c.x < -c.spriteLen && c.direction<0) c.x = maxCells;
    c.element.style.transform = `translateX(${c.x*cellWidth}px)`;
  });

  if(active){
    requestAnimationFrame(animate); // ~60 FPS
  } else {
    setTimeout(animate, 1000/15);   // ~15 FPS
  }
}
animate();
</script>
</body>
</html>
